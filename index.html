<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <title>Travellog</title>
    <link rel="stylesheet" href="./travellog.css"/>

    <link rel="stylesheet" href="./leaflet/leaflet.css"/>
    <script src="./leaflet/leaflet.js"></script>

    <script src="leaflet-gpx-master/gpx.min.js"></script>
    <script src="./data/roadtrips.js"></script>
    <script src="./data/interrail.js"></script>
    <script src="./data/places_of_residence.js"></script>
    <script src="./data/cities.js"></script>
    <script src="./leaflet-providers/leaflet-providers.js"></script>
    <!--<script src="./keys.js"></script>-->
</head>

<body>
<div class="navbarBackground">
    <br/>
</div>
<div class="navbarBackground">
    <br/>
</div>
<div class="navbar">
    <div class="dropdown" style="font-size: 0;">
        <img src="logos/logo-white_transparent_small.png" alt="logo">
    </div>
    <div class="dropdown">
        <!-- TODO why mauszeiger ohne button auch? -->
        <button class="dropLabel menuBreiteFilter">Filter:</button>
    </div>
    <div class="dropdown">
        <button class="dropbtn menuBreiteKaempfer" onclick="myFunction(1)">Reiseart
            <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content menuBreiteKaempfer" id="myDropdown1">
            <table border="0" cellpadding="2" cellspacing="0">
                <tr>
                    <th>Gewertet</th>
                    <th>Reiseart</th>
                </tr>
                <tr>
                    <td align="center"><input type="checkbox" id="filterKaempfer1" value="HKL"
                                              onClick="changeInterrail(event)" checked/></td>
                    <td align="center" colspan="3">Interrail</td>
                </tr>
                <tr>
                    <td align="center"><input type="checkbox" id="filterKaempfer2" value="HKL"
                                              onClick="changeRoadtrip(event)" checked/></td>
                    <td align="center" colspan="3">Roadtrip</td>
                </tr>
            </table>
        </div>
    </div>
    <div class="dropdown">
        <button class="dropbtn menuPlaces" onclick="myFunction(2)">Orte
            <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content menuPlaces" id="myDropdown2">
            <table border="0" cellpadding="2" cellspacing="0">
                <tr>
                    <th>Gewertet</th>
                    <th>Reiseart</th>
                </tr>
                <tr>
                    <td align="center"><input type="checkbox" id="filterPlaces1" value="HKL"
                                              onClick="changeResidence(event)" checked/></td>
                    <td align="center" colspan="3">Places Lived</td>
                </tr>
                <tr>
                    <td align="center"><input type="checkbox" id="filterPlaces2" value="HKL" onClick="changeCity(event)"
                                              checked/></td>
                    <td align="center" colspan="3">Places Traveled</td>
                </tr>
            </table>
        </div>
    </div>
    <a href="https://github.com/ippon1">
        <div class="dropdown">
            <button class="dropbtn">Source Code</button>
        </div>
    </a>
    <a href="https://simonreisinger.com/privacy-policy">
        <div class="dropdown">
            <button class="dropbtn">Impressum</button>
        </div>
    </a>
</div>
<div class="navbarPlaceholer">
    <br/>
</div>


<!-- To display the map -->
<div id="map"></div>

<script>
    /////////////////Menu///////////////////////////
    /* When the user clicks on the button, toggle between hiding and showing the dropdown content */
    function myFunction(i) {
        document.getElementById("myDropdown" + i).classList.toggle("show");
    }

    // Close the dropdown if the user clicks outside of it
    window.onclick = function (e) {
        if (!e.target.matches('.dropbtn')) {
            var myDropdown1 = document.getElementById("myDropdown1");
            if (myDropdown1.classList.contains('show')) {
                myDropdown1.classList.remove('show');
            }
            var myDropdown2 = document.getElementById("myDropdown2");
            if (myDropdown2.classList.contains('show')) {
                myDropdown2.classList.remove('show');
            }
        }
    };
    /////////////////Menu///////////////////////////

    // initialize the map
    let map = L.map('map').setView([45, -40], 3.4);

    // load a tile layer
    L.tileLayer('http://a.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Tiles by <a href="https://opentopomap.org/">OpenTopoMap</a>',
        maxZoom: 17,
        minZoom: 1
    }).addTo(map);

    // TODO activate after debugging
    //L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
    //    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    //    subdomains: 'abcd',
    //    minZoom: 0,
    //    maxZoom: 18,
    //    ext: 'png'
    //}).addTo(map);

    // localhoast map
    //L.tileLayer.provider('Stadia.AlidadeSmooth').addTo(map);

    let layer_roadtrip = L.featureGroup();
    for (let gps_road in roadtrips) {

        let gpx = roadtrips[gps_road];

        let g = new L.GPX(gpx, {
            async: true,
            parseElements: ['track'],
            polyline_options: {
                color: '#333',
                weight: 3,
                opacity: 0.6,
            }
        });

        g.on('loaded', function (e) {
            let gpx = e.target,
                name = gpx.get_name(),
                distM = gpx.get_distance(),
                distKm = distM / 1000,
                distKmRnd = distKm.toFixed(1),
                eleGain = gpx.get_elevation_gain().toFixed(0),
                eleLoss = gpx.get_elevation_loss().toFixed(0);
            let info = "Name: " + name + "</br>" +
                "Distance: " + distKmRnd + " km </br>";

            // register popup on click
            gpx.bindPopup(info);
            gpx.on('mouseover', function (e) {
                let p = L.point([e.originalEvent.clientX,e.originalEvent.clientY-50]);
                console.log(p);
                let latlng = map.containerPointToLatLng(p);
                this.openPopup(latlng);
            });
            gpx.on('mouseout', function (e) {
                this.closePopup();
            });
        });
        g.addTo(layer_roadtrip);
    }
    map.addLayer(layer_roadtrip);

    let layer_interrail = L.featureGroup();
    for (let gps_int in interrail) {

        let gpx = interrail[gps_int];

        let g = new L.GPX(gpx, {
            async: true,
            parseElements: ['track'],
            polyline_options: {
                color: 'red',
                weight: 3,
                opacity: 0.6,
            }
        });

        g.on('loaded', function (e) {
            let gpx = e.target,
                name = gpx.get_name(),
                distM = gpx.get_distance(),
                distKm = distM / 1000,
                distKmRnd = distKm.toFixed(1),
                eleGain = gpx.get_elevation_gain().toFixed(0),
                eleLoss = gpx.get_elevation_loss().toFixed(0);
            let info = "Name: " + name + "</br>" +
                "Distance: " + distKmRnd + " km </br>";

            // register popup on click
            gpx.bindPopup(info);
            // TODO https://stackoverflow.com/questions/59193983/leaflet-show-popup-on-hover-with-the-location-of-the-mouse
            gpx.on('mouseover', function (e) {
                let p = L.point([e.originalEvent.clientX,e.originalEvent.clientY-50]);
                let latlng = map.containerPointToLatLng(p);
                this.openPopup(latlng);
            });
            gpx.on('mouseout', function (e) {
                this.closePopup();
            });
        });
        g.addTo(layer_interrail);
    }
    map.addLayer(layer_interrail);

    let layer_residence = L.featureGroup();
    for (let residence in place_of_residence) {
        let position = place_of_residence[residence];
        let marker = L.circleMarker([position.Lat, position.Lon], {
            color: '#EDA540',
            fillColor: '#EDA540',
            opacity: 0.84,
            radius: 12
        }).addTo(layer_residence);
        marker.bindPopup(position);
        marker.on('mouseover', function (e) {
            this.openPopup();
        });
        marker.on('mouseout', function (e) {
            this.closePopup();
        });

    }
    map.addLayer(layer_residence);

    let layer_city = L.featureGroup();
    for (let city in cities_visited) {
        let position = cities_visited[city];
        let marker = L.circleMarker([position.Lat, position.Lon], {
            color: '#E67700',
            fillColor: '#E67700',
            opacity: 0.84,
            radius: 12
        }).addTo(layer_city);

        marker.bindPopup(city);
        marker.on('mouseover', function (e) {
            this.openPopup();
        });
        marker.on('mouseout', function (e) {
            this.closePopup();
        });
    }
    map.addLayer(layer_city);


    function changeRoadtrip(e) {
        if (e.target.checked) {
            map.addLayer(layer_roadtrip);
        } else {
            map.removeLayer(layer_roadtrip);
        }
    }

    function changeInterrail(e) {
        if (e.target.checked) {
            map.addLayer(layer_interrail);
        } else {
            map.removeLayer(layer_interrail);
        }
    }

    function changeResidence(e) {
        if (e.target.checked) {
            map.addLayer(layer_residence);
        } else {
            map.removeLayer(layer_residence);
        }
    }

    function changeCity(e) {
        if (e.target.checked) {
            map.addLayer(layer_city);
        } else {
            map.removeLayer(layer_city);
        }
    }

</script>
</body>
</html>